name: Deploy to Supabase

on:
  push:
    branches:
      - main
      - staging
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: cicd
    
    # Job å±¤ç´šè¨­å®šï¼Œæ‰€æœ‰ steps éƒ½æœƒç¹¼æ‰¿
    defaults:
      run:
        working-directory: ./supabase
    
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '23'

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Verify Environment
        run: |
          echo "ğŸ” Verifying configuration..."
          echo "Working directory: $(pwd)"
          echo "Supabase CLI version: $(supabase --version)"
          
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
            echo "âŒ SUPABASE_ACCESS_TOKEN is not set"
            exit 1
          fi
          
          if [ -z "$SUPABASE_PROJECT_REF" ]; then
            echo "âŒ SUPABASE_PROJECT_REF is not set"
            exit 1
          fi
          
          echo "âœ… Environment verified"

      - name: Link to Supabase Project
        run: |
          echo "ğŸ”— Linking to Supabase project: $SUPABASE_PROJECT_REF"
          supabase link --project-ref "$SUPABASE_PROJECT_REF"
          echo "âœ… Successfully linked"

      - name: Repair Migration History
        run: |
          echo "ğŸ”§ Repairing migration history..."
          
          # æ¨™è¨˜æ‰€æœ‰ç¾æœ‰ migrations ç‚ºå·²æ‡‰ç”¨
          supabase migration repair --status applied 00001 || true
          supabase migration repair --status applied 00002 || true
          supabase migration repair --status applied 00003 || true
          supabase migration repair --status applied 00004 || true
          supabase migration repair --status applied 00005 || true
          supabase migration repair --status applied 00006 || true
          
          echo "âœ… Migration history repaired"

      - name: Push Database Migrations
        run: |
          echo "ğŸ“¦ Pushing database migrations..."
          supabase db push --linked
          echo "âœ… Migrations pushed successfully"

      - name: Deploy Edge Functions
        run: |
          echo "ğŸš€ Deploying Edge Functions..."
          
          FUNCTIONS=(
            "create-session"
            "create-order"
            "create-payment"
            "payment-callback"
          )
          
          for func in "${FUNCTIONS[@]}"; do
            echo "Deploying $func..."
            supabase functions deploy "$func" --no-verify-jwt
          done
          
          echo "âœ… All functions deployed"

      - name: Set Function Secrets
        env:
          ECPAY_MERCHANT_ID: ${{ secrets.ECPAY_MERCHANT_ID }}
          ECPAY_HASH_KEY: ${{ secrets.ECPAY_HASH_KEY }}
          ECPAY_HASH_IV: ${{ secrets.ECPAY_HASH_IV }}
          ECPAY_STAGING_URL: ${{ secrets.ECPAY_STAGING_URL }}
          ECPAY_PRODUCTION_URL: ${{ secrets.ECPAY_PRODUCTION_URL }}
        run: |
          echo "ğŸ” Setting function secrets..."
          
          supabase secrets set \
            ECPAY_MERCHANT_ID="$ECPAY_MERCHANT_ID" \
            ECPAY_HASH_KEY="$ECPAY_HASH_KEY" \
            ECPAY_HASH_IV="$ECPAY_HASH_IV" \
            ECPAY_STAGING_URL="$ECPAY_STAGING_URL" \
            ECPAY_PRODUCTION_URL="$ECPAY_PRODUCTION_URL"
          
          echo "âœ… Secrets configured"

      - name: Deployment Summary
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Deployment completed successfully!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Database migrations: âœ…"
          echo "ğŸš€ Edge Functions: âœ…"
          echo "ğŸ” Function Secrets: âœ…"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Project: $SUPABASE_PROJECT_REF"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ Deployment failed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Please check the logs above for details"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"